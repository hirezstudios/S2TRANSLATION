{% extends 'base.html' %}

{% block title %}Edit Rule: {{ description }}{% endblock %}

{% block content %}
    <h2>Edit: {{ description }}</h2>
    <small class="text-muted mb-3 d-block">File: {{ filename }}</small>

    {# Display flashed messages if save fails #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form id="edit-rule-form" method="post" action="{{ url_for('edit_rule', filename=filename) }}">
        <div class="mb-3">
            <label for="codemirror-editor" class="form-label">Rule Content:</label>
            {# This textarea will be replaced by CodeMirror, but holds the initial value and submitted value #}
            <textarea id="codemirror-editor" name="edited_content" class="form-control" style="height: 1000px;">{{ content }}</textarea>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a href="{{ url_for('view_rule', filename=filename) }}" class="btn btn-secondary">Cancel</a>
    </form>

{% endblock %}

{% block scripts %}
    {{ super() }} {# Include scripts from base.html if any #}
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css"> {# Example theme #}

    <!-- Add custom styles for CodeMirror font size -->
    <style>
      .CodeMirror {
        font-size: 0.7em; /* Adjust as needed */
        border: 1px solid #ced4da; /* Add a subtle border like other form elements */
        border-radius: 0.25rem;
      }
    </style>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const editorTextarea = document.getElementById('codemirror-editor');
            const editor = CodeMirror.fromTextArea(editorTextarea, {
                lineNumbers: true,
                mode: 'markdown',
                theme: 'material-darker', // Or choose another theme
                matchBrackets: true,
                lineWrapping: true
            });

            // Ensure the textarea is updated with CodeMirror content before form submission
            const form = document.getElementById('edit-rule-form');
            form.addEventListener('submit', function() {
                editor.save(); // This copies the content from the editor back to the original textarea
            });
        });
    </script>
{% endblock %} 